
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>eRT Odisha | Teacher Portal Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <style>
      :root {
            /* Professional Color Palette */
            --primary: #1a73e8;       /* Google Blue */
            --primary-dark: #1557b0;
            --success: #2e7d32;       /* Success Green */
            --warning: #f9a825;       /* Warning Yellow */
            --danger: #d32f2f;        /* Error Red */
            --bg-body: #f0f2f5;       /* Light Gray Background */
            --card-bg: #ffffff;
            --text-main: #202124;
            --text-muted: #5f6368;
            --gold: #FFD700;          /* Certificate Gold */
            
            --radius: 12px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; transition: all 0.2s ease; }
        
        body { margin: 0; background-color: var(--bg-body); color: var(--text-main); padding-bottom: 60px; }

        /* --- LAYOUT UTILS --- */
        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        .hidden { display: none !important; }
        .card { 
            background: var(--card-bg); 
            border-radius: var(--radius); 
            padding: 24px; 
            box-shadow: var(--shadow-sm); 
            margin-bottom: 20px; 
            border: 1px solid #e0e0e0;
        }

        /* --- CERTIFICATE CARD --- */
        .cert-card {
            background: linear-gradient(135deg, #fff8e1 0%, #ffffff 100%);
            border: 1px solid #ffe082;
            text-align: center;
        }
        .cert-icon { font-size: 2rem; margin-bottom: 10px; }
        .btn-gold {
            background: #fbc02d; color: #000;
            box-shadow: 0 2px 5px rgba(249, 168, 37, 0.4);
        }
        .btn-gold:hover { background: #f9a825; }

        /* --- TOP BAR --- */
        .top-bar {
            background: var(--card-bg);
            padding: 10px 20px;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .brand-group { display: flex; align-items: center; gap: 12px; }
        .app-logo { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; }
        .brand-text h2 { margin: 0; font-size: 1.1rem; color: var(--primary); }

        /* Profile Button in Header */
        .profile-btn {
            background: none; border: none; cursor: pointer;
            display: flex; align-items: center; gap: 10px; padding: 5px 10px;
            border-radius: 30px; transition: background 0.2s;
        }
        .profile-btn:hover { background: #f1f3f4; }
        .header-pfp { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; box-shadow: 0 0 0 1px #ddd; }
        .header-info { text-align: left; display: none; } /* Show on larger screens */
        @media (min-width: 600px) { .header-info { display: block; } }

        /* --- BUTTONS --- */
        .btn { padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; border: none; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-outline { background: white; border: 1px solid #dadce0; color: var(--text-muted); width: 100%; }
        .btn-danger { background: #ffebee; color: var(--danger); }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }

        /* --- FORMS --- */
        label { display: block; font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { 
            width: 100%; padding: 12px; border: 1px solid #dadce0; border-radius: 8px; font-size: 1rem; margin-bottom: 15px; 
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(26,115,232,0.15); }

        /* --- ANALYTICS DASHBOARD --- */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; border-bottom: 3px solid var(--primary); box-shadow: var(--shadow-sm); }
        .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--text-main); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; }

        /* --- QUESTION LIST --- */
        .q-item { padding: 16px; border: 1px solid #f0f0f0; border-radius: 8px; margin-bottom: 12px; background: #fafafa; position: relative; }
        .q-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; }
        .badge-live { background: #e8f5e9; color: var(--success); }
        .badge-pending { background: #fff3e0; color: var(--warning); }
        
        .q-tag { font-size: 0.7em; padding: 2px 6px; border-radius: 4px; margin-left: 5px; font-weight: bold; }
        .tag-mcq { background: #e3f2fd; color: #1565c0; }
        .tag-short { background: #fff3e0; color: #ef6c00; }
        .tag-long { background: #f3e5f5; color: #7b1fa2; }

        .q-actions { margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end; }
        .q-img-preview { max-width: 100px; display: block; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; }

        /* --- PROFILE EDITOR --- */
        .pfp-wrapper { position: relative; width: 100px; height: 100px; margin: 0 auto 15px; cursor: pointer; }
        .pfp-large { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .cam-icon { position: absolute; bottom: 0; right: 0; background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; font-size: 1rem; }

        /* --- SKELETON LOADING --- */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; margin-bottom: 8px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* --- FULLSCREEN EDITOR --- */
        #fullscreen-editor { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: none; flex-direction: column; }
        .fs-toolbar { padding: 10px 20px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #rich-content { flex: 1; padding: 30px; font-size: 1.2rem; outline: none; overflow-y: auto; max-width: 800px; margin: 0 auto; width: 100%; }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="brand-group">
        <img src="logo.jpg" onerror="this.src='https://via.placeholder.com/40'" alt="Logo" class="app-logo" />
        <div class="brand-text">
          <h2>eRT Odisha</h2>
        </div>
      </div>
      <div id="auth-actions" class="hidden">
        <button class="profile-btn" onclick="toggleView('profile')">
          <img id="header-pfp" src="https://via.placeholder.com/50" class="header-pfp" />
          <div class="header-info">
            <span id="header-name" style="display:block; font-weight:600; font-size:0.85rem;">Teacher</span>
            <span style="font-size:0.7rem; color:var(--text-muted);">View Profile</span>
          </div>
        </button>
      </div>
    </div>
    
    <div class="container">
      <div id="auth-section" class="card" style="max-width: 400px; margin: 40px auto; text-align: center;">
        <h3 id="auth-title" style="margin-top:0;">Teacher Portal Login</h3>
        <p style="color:var(--text-muted); margin-bottom:20px;">Welcome back! Please enter your details.</p>
        <input type="email" id="email" placeholder="Email Address" />
        <input type="password" id="password" placeholder="Password" />
        <div id="signup-fields" class="hidden">
          <input type="text" id="tName" placeholder="Full Name" />
          <input type="text" id="tDistrict" placeholder="District" />
          <input type="text" id="tBlock" placeholder="Block" />
        </div>
        <button onclick="handleAuth()" id="authBtn" class="btn btn-primary">Login</button>
        <p onclick="toggleAuthMode()" style="cursor:pointer; color:var(--primary); font-size:0.9rem; margin-top:15px;">
          <span id="auth-toggle-text">New here? Create an account</span>
        </p>
      </div>

      <div id="dashboard-section" class="hidden">
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Questions</div>
            <div id="stat-total" class="stat-val">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Live Status</div>
            <div id="stat-live" class="stat-val" style="color:var(--success)">0</div>
          </div>
        </div>

        <div id="certificate-wrapper" class="card cert-card hidden">
            <div class="cert-icon">üèÜ</div>
            <h3 style="margin-top:0; color: #f57f17;">Certificate of Appreciation</h3>
            <p style="color:var(--text-muted);">Congratulations! You have submitted <strong>100+ questions</strong>.</p>
            <button id="certBtn" class="btn btn-gold" onclick="generateCertificate()">
               Download Certificate
            </button>
        </div>

        <div class="card">
          <h3 style="margin-top:0;">Add New Question</h3>
          <input type="hidden" id="editId" />
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <label>Exam Type</label>
              <select id="qExam" onchange="handleExamChange()">
                <option value="" disabled="" selected="">-- Select --</option>
                <option value="5TH BOARD">5th Board</option>
                <option value="8TH BOARD">8th Board</option>
              </select>
            </div>
            <div>
              <label>Subject</label>
              <select id="qSubject">
                <option value="" disabled="" selected="">-- Select Exam First --</option>
              </select>
            </div>
          </div>
          <div id="cat-wrapper" class="hidden">
            <label>Question Category</label>
            <select id="qCategory" onchange="handleCategoryChange()">
              <option value="Very Short">Very Short Answer (1 Mark)</option>
              <option value="Short">Short Answer (2-3 Marks)</option>
              <option value="Long">Long Answer (5 Marks)</option>
            </select>
          </div>
          <label style="display:flex; justify-content:space-between; align-items:center;">
            Question Text
            <button class="btn btn-sm btn-outline" onclick="openEditor('qText')">‚õ∂ Fullscreen Editor</button>
          </label>
          <textarea id="qText" rows="3" placeholder="Type question here..."></textarea>
          <input type="file" id="qImage" accept="image/*" style="padding: 5px;" />
          <div id="mcq-inputs">
            <label>Options</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom:15px;">
              <input type="text" id="opA" placeholder="Option A" style="margin:0;" />
              <input type="text" id="opB" placeholder="Option B" style="margin:0;" />
              <input type="text" id="opC" placeholder="Option C" style="margin:0;" />
              <input type="text" id="opD" placeholder="Option D" style="margin:0;" />
            </div>
            <label>Correct Answer</label>
            <select id="correctAns">
              <option value="A">Option A</option>
              <option value="B">Option B</option>
              <option value="C">Option C</option>
              <option value="D">Option D</option>
            </select>
          </div>
          <div id="subjective-inputs" class="hidden">
            <label style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
              Answer Key
              <button class="btn btn-sm btn-outline" onclick="openEditor('ansText')">‚õ∂ Fullscreen Editor</button>
            </label>
            <textarea id="ansText" rows="3" placeholder="Type the answer here..."></textarea>
            <label style="margin-top:10px;">Answer Image (Optional)</label>
            <input type="file" id="ansImage" accept="image/*" style="padding: 5px;" />
          </div>
          <div style="display:flex; gap:10px; margin-top:15px;">
            <button id="saveBtn" class="btn btn-primary" onclick="saveQuestion()">Submit Question</button>
            <button id="cancelBtn" class="btn btn-danger hidden" onclick="cancelEdit()">Cancel Edit</button>
          </div>
        </div>
        <div class="card">
          <h3 style="margin-top:0;">My Submissions</h3>
          <div id="my-questions-list">
            <div class="skeleton" style="height:20px; width:40%;"></div>
            <div class="skeleton" style="height:60px; width:100%;"></div>
            <div class="skeleton" style="height:20px; width:70%;"></div>
          </div>
        </div>
      </div>

      <div id="profile-section" class="hidden">
        <div class="card" style="max-width: 500px; margin: 0 auto; text-align: center;">
          <h3 style="margin-top:0;">Edit Profile</h3>
          <div class="pfp-wrapper" onclick="document.getElementById('pfpInput').click()">
            <img id="pfp-preview" src="https://via.placeholder.com/150" class="pfp-large" />
            <div class="cam-icon">üì∑</div>
          </div>
          <input type="file" id="pfpInput" hidden="" accept="image/*" onchange="previewPfp(this)" />
          <div style="text-align: left;">
            <label>Full Name</label>
            <input type="text" id="editName" />
            <label>District</label>
            <input type="text" id="editDistrict" />
            <label>Block</label>
            <input type="text" id="editBlock" />
          </div>
          <button class="btn btn-primary" id="saveProfileBtn" onclick="saveProfileChanges()">Save Changes</button>
          <button class="btn btn-outline" style="margin-top:10px;" onclick="toggleView('dashboard')">Cancel</button>
          <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
            <button class="btn btn-danger" style="width:100%;" onclick="logout()">Log Out</button>
          </div>
        </div>
      </div>
    </div>
    <div id="fullscreen-editor">
      <div class="fs-toolbar">
        <strong>Rich Text Editor</strong>
        <button class="btn btn-primary btn-sm" onclick="closeEditor()">Save &amp; Close</button>
      </div>
      <div id="rich-content" contenteditable="true"></div>
    </div>
    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script type="module">
        import { db, auth } from "./firebase-config.js"; 
        import { createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        
        import { collection, addDoc, updateDoc, setDoc, getDoc, deleteDoc, doc, query, where, onSnapshot, orderBy, enableIndexedDbPersistence } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Try offline persistence
        try { enableIndexedDbPersistence(db).catch(err => console.log("Persistence suppressed")); } catch(e){}

        // --- GLOBAL STATE ---
        let currentUser = null;
        let isSignup = false;
        let activeEditorTarget = "";
        let currentMode = "MCQ";
        
        // ============================================
        // !!! CERTIFICATE CONFIGURATION !!!
        // ============================================
        const CERT_CONFIG = {
            imageUrl: "./certificate.jpg", 
            
            // --- NAME CONFIG (Centered Logic) ---
            y: 1381,
            startX: 869,  
            endX: 2633,
            baseFontSize: 90, 
            
            // --- DATE CONFIG (Autofilled) ---
            dateX: 2141,
            dateY: 2089,
            dateFontSize: 45, 
            
            color: "#000000"
        };
        // ============================================

        // --- CONFIGURATION ---
        const examConfig = {
            "OAV": { type: "MCQ", subjects: ["Math", "Science", "Social", "English"] },
            "NAVODAYA": { type: "MCQ", subjects: ["Mental Ability", "Math", "Language"] },
            "NMMS": { type: "MCQ", subjects: ["MAT", "SAT"] },
            "5TH BOARD": { 
                type: "SUBJECTIVE", 
                subjects: ["Odia (Sahitya)", "English", "Mathematics", "Environmental Studies (EVS)"] 
            },
            "8TH BOARD": { 
                type: "SUBJECTIVE", 
                subjects: ["Odia (Sahitya)", "English", "Hindi", "Sanskrit", "Mathematics", "General Science", "History & Pol Sc", "Geography"] 
            },
            "PATHANI SAMANTA": { type: "MCQ", subjects: ["Math"] }
        };

        const compressImage = (file, maxWidth, quality) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = maxWidth / img.width;
                        canvas.width = Math.min(img.width, maxWidth);
                        canvas.height = img.height * (img.width > maxWidth ? scale : 1);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.onerror = reject;
                };
            });
        };

        window.showToast = (msg, type="success") => {
            Toastify({
                text: msg, duration: 3000, gravity: "top", position: "right",
                style: { background: type === "success" ? "var(--success)" : "var(--danger)", borderRadius: "8px" }
            }).showToast();
        };

        window.toggleView = (viewName) => {
            document.getElementById('dashboard-section').classList.add('hidden');
            document.getElementById('profile-section').classList.add('hidden');
            document.getElementById('auth-section').classList.add('hidden');
            
            if(viewName === 'dashboard') document.getElementById('dashboard-section').classList.remove('hidden');
            if(viewName === 'profile') {
                document.getElementById('profile-section').classList.remove('hidden');
                loadProfileData(); 
            }
            if(viewName === 'auth') document.getElementById('auth-section').classList.remove('hidden');
        };

        window.toggleAuthMode = () => {
            isSignup = !isSignup;
            document.getElementById('auth-title').innerText = isSignup ? "Create Teacher Account" : "Teacher Portal Login";
            document.getElementById('authBtn').innerText = isSignup ? "Sign Up" : "Login";
            document.getElementById('signup-fields').classList.toggle('hidden', !isSignup);
            document.getElementById('auth-toggle-text').innerText = isSignup ? "Already have an account? Login" : "New here? Create an account";
        };

        window.handleAuth = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('authBtn');
            
            if(!email || !pass) return showToast("Please fill all fields", "error");
            
            btn.innerText = "Processing..."; btn.disabled = true;

            try {
                if(isSignup) {
                    const name = document.getElementById('tName').value;
                    const district = document.getElementById('tDistrict').value;
                    const block = document.getElementById('tBlock').value;
                    if(!name) throw new Error("Name is required");

                    const cred = await createUserWithEmailAndPassword(auth, email, pass);
                    await updateProfile(cred.user, { displayName: `${name} | ${district} | ${block}` });
                    await setDoc(doc(db, "users", cred.user.uid), {
                        email: email, role: "teacher", base64Photo: "" 
                    });
                    showToast("Account created! Welcome.");
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                    showToast("Login successful");
                }
            } catch(e) {
                showToast(e.message, "error");
                btn.innerText = isSignup ? "Sign Up" : "Login";
                btn.disabled = false;
            }
        };

        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                await loadUserImage(user.uid); 
                updateHeaderInfo(user);
                toggleView('dashboard');
                document.getElementById('auth-actions').classList.remove('hidden');
                loadMyQuestions(user.uid);
            } else {
                currentUser = null;
                toggleView('auth');
                document.getElementById('auth-actions').classList.add('hidden');
            }
        });

        async function loadUserImage(uid) {
            try {
                const docSnap = await getDoc(doc(db, "users", uid));
                if (docSnap.exists() && docSnap.data().base64Photo) {
                    window.currentUserPhoto = docSnap.data().base64Photo;
                } else {
                    window.currentUserPhoto = "https://via.placeholder.com/50";
                }
            } catch(e) {
                window.currentUserPhoto = "https://via.placeholder.com/50";
            }
        }

        function updateHeaderInfo(user) {
            const parts = (user.displayName || "").split('|').map(s=>s.trim());
            document.getElementById('header-name').innerText = parts[0] || "Teacher";
            document.getElementById('header-pfp').src = window.currentUserPhoto;
        }

        function loadProfileData() {
            const user = auth.currentUser;
            const parts = (user.displayName || "").split('|').map(s=>s.trim());
            document.getElementById('editName').value = parts[0] || "";
            document.getElementById('editDistrict').value = parts[1] || "";
            document.getElementById('editBlock').value = parts[2] || "";
            document.getElementById('pfp-preview').src = window.currentUserPhoto;
        }

        window.previewPfp = async (input) => {
            if(input.files && input.files[0]) {
                const url = await compressImage(input.files[0], 200, 0.5); 
                document.getElementById('pfp-preview').src = url;
            }
        };

        window.saveProfileChanges = async () => {
            const btn = document.getElementById('saveProfileBtn');
            btn.innerText = "Saving..."; btn.disabled = true;
            try {
                const name = document.getElementById('editName').value;
                const dist = document.getElementById('editDistrict').value;
                const block = document.getElementById('editBlock').value;
                const pfpBase64 = document.getElementById('pfp-preview').src;

                await updateProfile(auth.currentUser, { displayName: `${name} | ${dist} | ${block}` });
                await setDoc(doc(db, "users", auth.currentUser.uid), { base64Photo: pfpBase64 }, { merge: true });

                window.currentUserPhoto = pfpBase64;
                updateHeaderInfo(auth.currentUser);
                showToast("Profile Updated!");
                toggleView('dashboard');
            } catch(e) {
                showToast(e.message, "error");
            } finally {
                btn.innerText = "Save Changes"; btn.disabled = false;
            }
        };

        window.handleExamChange = () => {
            const exam = document.getElementById('qExam').value;
            const subSelect = document.getElementById('qSubject');
            subSelect.innerHTML = '<option disabled selected>-- Select Subject --</option>';
            if(examConfig[exam]) {
                examConfig[exam].subjects.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub}">${sub}</option>`;
                });
                currentMode = examConfig[exam].type;
                toggleFormMode(currentMode);
            }
        };

        function toggleFormMode(mode) {
            const isSub = mode === 'SUBJECTIVE';
            document.getElementById('mcq-inputs').classList.toggle('hidden', isSub);
            document.getElementById('subjective-inputs').classList.toggle('hidden', !isSub);
            document.getElementById('cat-wrapper').classList.toggle('hidden', !isSub);
            if(isSub) {
                document.getElementById('qCategory').value = "Very Short";
                handleCategoryChange();
            }
        }

        window.handleCategoryChange = () => {
            const cat = document.getElementById('qCategory').value;
            const ansInput = document.getElementById('ansText');
            if (cat === "Very Short") { ansInput.rows = 1; ansInput.placeholder = "Type one word or one sentence answer..."; }
            else if (cat === "Short") { ansInput.rows = 3; ansInput.placeholder = "Type short answer (2-3 lines)..."; }
            else { ansInput.rows = 6; ansInput.placeholder = "Type detailed explanation..."; }
        };

        window.saveQuestion = async () => {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Publishing..."; btn.disabled = true;
            try {
                const editId = document.getElementById('editId').value;
                const exam = document.getElementById('qExam').value;
                const subject = document.getElementById('qSubject').value;
                const text = document.getElementById('qText').value;

                if(!exam || !subject || !text) throw new Error("Please fill required fields.");

                const data = {
                    exam, subject, question: text, type: currentMode,
                    uid: currentUser.uid, teacher: currentUser.displayName,
                    timestamp: Date.now(), verified: false
                };

                const file = document.getElementById('qImage').files[0];
                if(file) data.imageUrl = await compressImage(file, 600, 0.6);

                if(currentMode === 'MCQ') {
                    data.options = {
                        A: document.getElementById('opA').value, B: document.getElementById('opB').value,
                        C: document.getElementById('opC').value, D: document.getElementById('opD').value
                    };
                    data.answer = document.getElementById('correctAns').value;
                } else {
                    data.category = document.getElementById('qCategory').value;
                    data.answerText = document.getElementById('ansText').value;
                    const ansFile = document.getElementById('ansImage').files[0];
                    if(ansFile) data.answerImage = await compressImage(ansFile, 600, 0.6);
                }

                if(editId) {
                    await updateDoc(doc(db, "questions", editId), data);
                    showToast("Question Updated Successfully!");
                    cancelEdit();
                } else {
                    await addDoc(collection(db, "questions"), data);
                    showToast("Question Published Successfully!");
                    document.getElementById('qText').value = "";
                    document.getElementById('qImage').value = "";
                    document.getElementById('opA').value = ""; document.getElementById('opB').value = "";
                    document.getElementById('opC').value = ""; document.getElementById('opD').value = "";
                    document.getElementById('ansText').value = ""; document.getElementById('ansImage').value = "";
                }
            } catch(e) {
                showToast(e.message, "error");
            } finally {
                btn.innerText = "Submit Question"; btn.disabled = false;
            }
        };

        function loadMyQuestions(uid) {
            const qRef = query(collection(db, "questions"), where("uid", "==", uid), orderBy("timestamp", "desc"));
            onSnapshot(qRef, (snap) => {
                const list = document.getElementById('my-questions-list');
                let total = 0, verified = 0;
                
                if(snap.empty) {
                    list.innerHTML = "<p style='text-align:center; color:#888;'>No questions yet. Add one!</p>";
                } else {
                    list.innerHTML = "";
                    snap.forEach(docSnap => {
                        const d = docSnap.data();
                        total++;
                        if(d.verified) verified++;
                        
                        let typeBadge = d.type === 'MCQ' ? `<span class="q-tag tag-mcq">MCQ</span>` : 
                                        `<span class="q-tag tag-short">${d.category || 'Subj'}</span>`;
                        const statusBadge = d.verified ? `<span class="badge badge-live">‚óè LIVE</span>` : `<span class="badge badge-pending">‚óè PENDING</span>`;
                            
                        const item = document.createElement('div');
                        item.className = "q-item";
                        item.innerHTML = `
                            <div class="q-header">
                                <span style="font-size:0.8rem; font-weight:700; color:var(--primary);">${d.exam} ‚Ä¢ ${d.subject}</span>
                                <div>${typeBadge} ${statusBadge}</div>
                            </div>
                            <div style="font-weight:500;">${d.question.substring(0, 100)}...</div>
                            <div class="q-actions">
                                <button class="btn btn-sm btn-outline" onclick="editQ('${docSnap.id}')">Edit</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteQ('${docSnap.id}')">Delete</button>
                            </div>
                        `;
                        item.dataset.json = JSON.stringify(d);
                        item.dataset.id = docSnap.id; 
                        list.appendChild(item);
                    });
                }
                
                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-live').innerText = verified;

                // --- CERTIFICATE LOGIC (Total >= 0 for Testing) ---
                if(total >= 100) { 
                    document.getElementById('certificate-wrapper').classList.remove('hidden');
                } else {
                    document.getElementById('certificate-wrapper').classList.add('hidden');
                }
            });
        }

        // --- CERTIFICATE GENERATOR ---
        window.generateCertificate = () => {
            const btn = document.getElementById('certBtn');
            btn.innerText = "Generating...";
            btn.disabled = true;

            const name = auth.currentUser.displayName.split('|')[0].trim();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.crossOrigin = "Anonymous"; 
            img.src = CERT_CONFIG.imageUrl;

            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);

                // 1. DRAW NAME (Centered)
                const maxWidth = CERT_CONFIG.endX - CERT_CONFIG.startX;
                const centerX = CERT_CONFIG.startX + (maxWidth / 2);
                let currentFontSize = CERT_CONFIG.baseFontSize;
                ctx.font = `bold ${currentFontSize}px Arial`;
                let textWidth = ctx.measureText(name).width;

                if (textWidth > maxWidth) {
                    const ratio = maxWidth / textWidth;
                    currentFontSize = Math.floor(currentFontSize * ratio);
                    ctx.font = `bold ${currentFontSize}px Arial`;
                }
                ctx.fillStyle = CERT_CONFIG.color;
                ctx.textAlign = "center"; 
                ctx.fillText(name, centerX, CERT_CONFIG.y);

                // 2. DRAW DATE (Bottom)
                const today = new Date();
                const dateStr = today.toLocaleDateString('en-GB'); // DD/MM/YYYY
                ctx.font = `bold ${CERT_CONFIG.dateFontSize}px Arial`;
                ctx.textAlign = "left";
                ctx.fillText(dateStr, CERT_CONFIG.dateX, CERT_CONFIG.dateY);

                // Download
                const link = document.createElement('a');
                link.download = `Certificate_${name.replace(/\s+/g, '_')}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();

                btn.innerText = "Download Certificate";
                btn.disabled = false;
            };

            img.onerror = () => {
                showToast("Error: Place 'certificate.jpg' in this folder.", "error");
                btn.innerText = "Retry Download";
                btn.disabled = false;
            };
        };

        window.deleteQ = async (id) => {
            if(confirm("Delete?")) { await deleteDoc(doc(db, "questions", id)); showToast("Deleted", "info"); }
        };

        window.editQ = (id) => {
            const item = document.querySelector(`.q-item[data-id="${id}"]`);
            if(!item) return;
            const data = JSON.parse(item.dataset.json);
            
            document.getElementById('editId').value = id;
            document.getElementById('qExam').value = data.exam;
            handleExamChange(); 

            setTimeout(() => {
                document.getElementById('qSubject').value = data.subject;
                document.getElementById('qText').value = data.question;

                if(data.type === 'MCQ') {
                    document.getElementById('opA').value = data.options.A;
                    document.getElementById('opB').value = data.options.B;
                    document.getElementById('opC').value = data.options.C;
                    document.getElementById('opD').value = data.options.D;
                    document.getElementById('correctAns').value = data.answer;
                } else {
                    document.getElementById('qCategory').value = data.category;
                    handleCategoryChange(); 
                    document.getElementById('ansText').value = data.answerText;
                }
                document.getElementById('saveBtn').innerText = "Update Question";
                document.getElementById('cancelBtn').classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        };

        window.cancelEdit = () => {
            document.getElementById('editId').value = "";
            document.getElementById('qText').value = "";
            document.getElementById('qExam').value = "";
            document.getElementById('qSubject').innerHTML = "";
            document.getElementById('saveBtn').innerText = "Submit Question";
            document.getElementById('cancelBtn').classList.add('hidden');
        };

        window.openEditor = (target) => {
            activeEditorTarget = target;
            document.getElementById('rich-content').innerText = document.getElementById(target).value;
            document.getElementById('fullscreen-editor').style.display = "flex";
        };
        window.closeEditor = () => {
            if(activeEditorTarget) document.getElementById(activeEditorTarget).value = document.getElementById('rich-content').innerText;
            document.getElementById('fullscreen-editor').style.display = "none";
        };
    </script>
  </body>
</html>
