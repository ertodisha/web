
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>eRT Odisha - Admin Pro Dashboard</title>
    <style>
        /* --- ADMIN THEME --- */
        :root {
            --primary: #0d47a1; --primary-hover: #002171; --accent: #d32f2f;
            --bg-color: #f4f6f8; --success: #2e7d32; --warning: #fb8c00;
            --card-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: var(--bg-color); color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 0; border-radius: 12px; box-shadow: var(--card-shadow); overflow: hidden; min-height: 80vh;}
        
        /* LOGIN OVERLAY */
        #login-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: #0d47a1; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 12px; text-align: center; width: 300px; color: #333; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .login-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box;}
        .login-box button { width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .login-box button:hover { background: var(--primary-hover); }

        /* DASHBOARD HEADER */
        .header { background: var(--primary); padding: 20px 25px; color: white; display: flex; align-items: center; justify-content: space-between; }
        .brand { display: flex; align-items: center; gap: 15px; }
        .app-logo { height: 40px; width: 40px; border-radius: 50%; border: 2px solid white; background: white; }
        h1 { margin: 0; font-size: 1.5rem; color: white; }
        .logout-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 15px; border-radius: 20px; cursor: pointer; }

        /* --- STATS DASHBOARD --- */
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; background: #e0e0e0; border-bottom: 1px solid #ddd; }
        .stat-card { background: white; padding: 20px; text-align: center; cursor: default; transition: 0.2s; }
        .stat-card:hover { background: #fcfcfc; }
        .stat-card h3 { margin: 0; font-size: 0.85em; text-transform: uppercase; color: #777; letter-spacing: 1px; }
        .stat-card .count { font-size: 2rem; font-weight: 800; margin-top: 5px; color: #333; }
        .c-total { color: var(--primary) !important; } .c-pending { color: var(--accent) !important; } .c-verified { color: var(--success) !important; }

        /* --- TEACHER CONTRIBUTION SUMMARY --- */
        .contribution-section { padding: 15px 25px; background: #fff; border-bottom: 1px solid #eee; }
        .contribution-title { font-size: 0.85rem; font-weight: 700; color: #555; text-transform: uppercase; margin-bottom: 10px; display: block; }
        .contribution-tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .teacher-tag { background: #f1f3f4; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; color: #3c4043; border: 1px solid #dadce0; }
        .teacher-tag b { color: var(--primary); }

        /* --- TABS & TOOLS --- */
        .tabs { display: flex; background: #e3f2fd; border-bottom: 1px solid #bbdefb; border-top: 5px solid #e0e0e0;}
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; cursor: pointer; font-weight: bold; font-size: 1rem; color: #555; transition: 0.2s; border-bottom: 3px solid transparent; }
        .tab-btn:hover { background: #bbdefb; }
        .tab-btn.active { background: white; color: var(--primary); border-bottom: 3px solid var(--primary); }

        .toolbar { display: flex; gap: 15px; padding: 20px; background: #fff; flex-wrap: wrap; align-items: flex-end; border-bottom: 1px solid #eee; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.8em; font-weight: bold; color: #777; margin-bottom: 5px; text-transform: uppercase; }
        select { padding: 8px; min-width: 160px; border-radius: 4px; border: 1px solid #ccc; background: #fafafa; }
        .btn-dl { background: #00897b; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: bold; margin-left: auto; }

        /* TABLE */
        .table-wrap { padding: 0 20px; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border-bottom: 1px solid #eee; padding: 15px 10px; text-align: left; vertical-align: top; }
        th { color: #555; font-weight: 700; text-transform: uppercase; font-size: 0.85em; border-bottom: 2px solid #ddd; }
        tr:hover { background-color: #f9f9f9; }
        .thumb { max-width: 100px; max-height: 100px; border: 1px solid #ddd; padding: 2px; background: white; border-radius: 4px; display: block; margin-top: 8px; }
        .content-text { word-wrap: break-word; color: #222; font-size: 0.95rem; line-height: 1.5; }
        
        /* Edit Box */
        .edit-box { display: none; margin-top: 15px; background: #fffde7; padding: 15px; border: 1px solid #fff59d; border-radius: 6px; }
        .edit-box input, .edit-box textarea, .edit-box select { width: 100%; margin-top: 5px; border: 1px solid #fbc02d; padding: 8px; box-sizing: border-box; }
        
        /* Buttons */
        .action-col { display: flex; flex-direction: column; gap: 6px; }
        .btn-verify { background: var(--success); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-unverify { background: #fb8c00; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .btn-edit { background: #1976d2; color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 0.9em;}
        .btn-delete { background: #d32f2f; color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 0.9em;}

        .load-more-section { padding: 30px; text-align: center; background: #f9f9f9; border-top: 1px solid #eee; }
        .btn-load { background: #546e7a; color: white; border: none; padding: 12px 30px; cursor: pointer; border-radius: 30px; font-weight: bold; }
        
        /* Rich Editor */
        #fs-editor { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 5000; display: none; flex-direction: column; }
        .ed-toolbar { background: #eee; padding: 10px; display: flex; gap: 10px; border-bottom: 1px solid #ccc; align-items: center; }
        .ed-content { flex-grow: 1; padding: 30px; outline: none; overflow-y: auto; font-size: 1.2rem; max-width: 900px; margin: auto; }
        .visual-edit-btn { background: #fff3e0; color: #e65100; border: 1px solid #ffb74d; padding: 3px 6px; font-size: 10px; cursor: pointer; border-radius: 3px; font-weight: bold; vertical-align: middle; margin-left: 5px;}

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <h2 style="margin-bottom:20px;">eRT Odisha Admin</h2>
        <div class="login-box">
            <p>Admin Access</p>
            <input type="email" id="adminEmail" placeholder="Email Address">
            <input type="password" id="adminPass" placeholder="Password">
            <button onclick="handleAdminAuth()">Login / Create Admin</button>
            <p id="login-msg" style="color:#666; font-size:0.8rem; margin-top:15px;">Enter credentials to access dashboard.</p>
        </div>
    </div>

    <div id="fs-editor">
        <div class="ed-toolbar">
            <button onclick="execCmd('bold')"><b>B</b></button>
            <button onclick="execCmd('italic')"><i>I</i></button>
            <button onclick="execCmd('underline')"><u>U</u></button>
            <input type="color" onchange="execCmd('foreColor', this.value)" title="Text Color">
            <div style="flex-grow: 1;"></div>
            <button onclick="closeAdminEditor()" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Close & Save</button>
        </div>
        <div id="ed-body" class="ed-content" contenteditable="true"></div>
    </div>

    <div class="container" id="main-dash" style="opacity:0.3; pointer-events:none;">
        <div class="header">
            <div class="brand">
                <img src="logo.jpg" alt="Logo" class="app-logo">
                <h1>Admin Panel</h1>
            </div>
            <button class="logout-btn" onclick="adminLogout()">Log Out</button>
        </div>

        <div class="stats-bar">
            <div class="stat-card">
                <h3>Total Questions</h3>
                <div class="count c-total" id="stat-total">...</div>
            </div>
            <div class="stat-card">
                <h3>üî¥ Non-Verified</h3>
                <div class="count c-pending" id="stat-pending">...</div>
            </div>
            <div class="stat-card">
                <h3>‚úÖ Verified</h3>
                <div class="count c-verified" id="stat-verified">...</div>
            </div>
        </div>

        <div class="contribution-section">
            <span class="contribution-title">Teacher Contribution Summary (Full Database)</span>
            <div id="teacher-summary-list" class="contribution-tags">
                <span style="color:#999; font-size:0.8rem;">Calculating contributions...</span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('unverified')" id="tab-unverified">Pending Review</button>
            <button class="tab-btn" onclick="switchTab('verified')" id="tab-verified">Approved Database</button>
        </div>
        
        <div class="toolbar">
            <div class="filter-group">
                <label>Exam</label>
                <select id="filterExam" onchange="applyFilters()"><option value="all">All Exams</option></select>
            </div>
            <div class="filter-group">
                <label>Teacher</label>
                <select id="filterTeacher" onchange="applyFilters()"><option value="all">All Teachers</option></select>
            </div>
            <div class="filter-group">
                <label>Subject</label>
                <select id="filterSubject" onchange="applyFilters()"><option value="all">All Subjects</option></select>
            </div>
            
            <div style="margin-left: auto;">
                <button class="btn-dl" onclick="downloadJSON()">‚¨á JSON</button>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th style="width:20%">Metadata</th>
                        <th style="width:40%">Question Content</th>
                        <th style="width:25%">Answer Key</th>
                        <th style="width:15%">Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="4" style="text-align:center; padding:40px;"><div class="loader"></div></td></tr>
                </tbody>
            </table>
        </div>

        <div class="load-more-section">
            <button class="btn-load" onclick="window.showMoreLocal()">‚¨á Show 50 More (Instant)</button>
            <p style="margin-top: 10px; color: #888; font-size: 0.8em;" id="showing-count">Loading...</p>
        </div>
    </div>

    <script type="module">
        import { db, auth } from "./firebase-config.js";
        import { signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { collection, getDocs, onSnapshot, deleteDoc, updateDoc, doc, query, orderBy, limit, where, enableIndexedDbPersistence } 
        from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Persistence
        try { enableIndexedDbPersistence(db).catch(() => {}); } catch(e){}

        // --- GLOBAL STATE ---
        let allData = [];
        let filteredData = [];
        let allTeachers = new Set(); 
        let queryLimit = 6000; // Limit set to 6000 to cover full database
        let visibleLimit = 50; 
        let currentTab = 'unverified'; 
        let unsubscribe = null;
        let activeEditId = '';
        const masterExams = ["OAV", "NAVODAYA", "NMMS", "PATHANI SAMANTA", "5TH BOARD", "8TH BOARD", "EKALABYA"];

        // --- UNIFIED AUTHENTICATION ---
        window.handleAdminAuth = async () => {
            const email = document.getElementById('adminEmail').value;
            const pass = document.getElementById('adminPass').value;
            const msg = document.getElementById('login-msg');
            
            if(!email || !pass) { msg.innerText = "Please enter email & password"; msg.style.color="red"; return; }
            msg.innerText = "Processing..."; msg.style.color="#666";

            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    try {
                        await createUserWithEmailAndPassword(auth, email, pass);
                    } catch (createErr) {
                        msg.innerText = "Error: " + createErr.message; msg.style.color="red";
                    }
                } else {
                    msg.innerText = "Error: " + error.message; msg.style.color="red";
                }
            }
        };

        window.adminLogout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            const overlay = document.getElementById('login-overlay');
            const dash = document.getElementById('main-dash');
            
            if (user) {
                overlay.classList.add('hidden');
                dash.style.opacity = "1";
                dash.style.pointerEvents = "auto";
                if(allData.length === 0) {
                    fetchUserMetadata();
                    // updateStats called inside loadData flow now
                    loadData();
                }
            } else {
                overlay.classList.remove('hidden');
                dash.style.opacity = "0.3";
                dash.style.pointerEvents = "none";
                document.getElementById('login-msg').innerText = "Logged Out";
            }
        });

        // --- DATA LOGIC ---
        async function fetchUserMetadata() {
            try {
                const snapshot = await getDocs(collection(db, "users"));
                snapshot.forEach(doc => {
                    const d = doc.data();
                    const name = d.displayName || d.name || d.email; 
                    if(name) allTeachers.add(name);
                });
                updateDropdowns(); 
            } catch (e) { console.error("Error fetching users:", e); }
        }

        // UPDATED: Calculate stats locally from allData
        function updateStats() {
            try {
                const countVerified = allData.filter(d => d.verified === true).length;
                // Count anything not strictly verified as pending (false, undefined, null)
                const countPending = allData.length - countVerified;

                document.getElementById('stat-verified').innerText = countVerified;
                document.getElementById('stat-pending').innerText = countPending;
                document.getElementById('stat-total').innerText = allData.length;
            } catch (e) {
                console.error("Stats Error:", e);
                document.getElementById('stat-total').innerText = "Err";
            }
        }

        function updateContributionSummary() {
            const container = document.getElementById('teacher-summary-list');
            if (allData.length === 0) {
                container.innerHTML = `<span style="color:#999; font-size:0.8rem;">No data loaded for this tab.</span>`;
                return;
            }

            const counts = {};
            allData.forEach(item => {
                const rawName = item.teacher || "Unknown Teacher";
                const name = rawName.split('|')[0].trim();
                counts[name] = (counts[name] || 0) + 1;
            });

            const sortedTeachers = Object.entries(counts).sort((a, b) => b[1] - a[1]);

            container.innerHTML = sortedTeachers.map(([name, count]) => `
                <div class="teacher-tag">${name}: <b>${count}</b></div>
            `).join('');
        }

        window.switchTab = (tabName) => {
            currentTab = tabName;
            visibleLimit = 50; 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById('tableBody').innerHTML = `<tr><td colspan="4" style="text-align:center; padding:40px;"><div class="loader"></div></td></tr>`;
            loadData();
        };

        function loadData() {
            if (unsubscribe) unsubscribe();
            const collectionRef = collection(db, "questions");
            
            // NOTE: We download everything (limit 6000) so we can count accurately locally
            // We removed the 'where' clause for verified status so we get EVERYTHING in one go for accurate stats
            // Wait, if we remove 'where verified', we get everything, but previously we toggled tabs.
            // BETTER STRATEGY: Load EVERYTHING once (since you have only ~2000 questions) and filter tabs locally.
            // This fixes ALL sync issues.
            
            let q = query(collectionRef, limit(queryLimit));
            
            unsubscribe = onSnapshot(q, (snapshot) => {
                allData = [];
                snapshot.forEach(doc => allData.push({ ...doc.data(), id: doc.id }));
                
                // Sort by timestamp
                allData.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                updateDropdowns(); 
                updateStats(); // Updates top bars
                updateContributionSummary(); // Updates teacher list
            });
        }

        window.showMoreLocal = () => { visibleLimit += 50; applyFilters(); };

        function updateDropdowns() {
            const currentExam = document.getElementById('filterExam').value;
            const currentTeacher = document.getElementById('filterTeacher').value;
            const currentSubject = document.getElementById('filterSubject').value;

            const loadedExams = allData.map(d => d.exam).filter(Boolean);
            const combinedExams = [...new Set([...masterExams, ...loadedExams])].sort();
            populateSelect(document.getElementById('filterExam'), combinedExams, "All Exams", currentExam);

            const loadedTeachers = allData.map(d => d.teacher).filter(Boolean);
            const combinedTeachers = [...new Set([...allTeachers, ...loadedTeachers])].sort();
            populateSelect(document.getElementById('filterTeacher'), combinedTeachers, "All Teachers", currentTeacher);

            const subjects = [...new Set(allData.map(d => d.subject).filter(Boolean))].sort();
            populateSelect(document.getElementById('filterSubject'), subjects, "All Subjects", currentSubject);
            
            applyFilters();
        }

        function populateSelect(el, items, defaultText, selectedValue) {
            el.innerHTML = `<option value="all">${defaultText}</option>`;
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item; opt.innerText = item;
                if(item === selectedValue) opt.selected = true;
                el.appendChild(opt);
            });
        }

        window.applyFilters = () => {
            const e = document.getElementById('filterExam').value;
            const t = document.getElementById('filterTeacher').value;
            const s = document.getElementById('filterSubject').value;
            
            // MAIN FILTER LOGIC
            filteredData = allData.filter(item => {
                // 1. Tab Filter
                const isVerified = item.verified === true;
                if (currentTab === 'unverified' && isVerified) return false;
                if (currentTab === 'verified' && !isVerified) return false;

                // 2. Dropdown Filters
                return (e === "all" || item.exam === e) && 
                       (t === "all" || item.teacher === t) && 
                       (s === "all" || item.subject === s);
            });

            const dataToRender = filteredData.slice(0, visibleLimit);
            document.getElementById('showing-count').innerText = `Showing ${dataToRender.length} of ${filteredData.length} questions`;
            document.querySelector('.btn-load').style.display = dataToRender.length >= filteredData.length ? "none" : "inline-block";
            renderTable(dataToRender);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";
            if(data.length === 0) { tbody.innerHTML = `<tr><td colspan='4' style='text-align:center; padding:30px; color:#777;'>No data found.</td></tr>`; return; }
            
            const fragment = document.createDocumentFragment();
            data.forEach(item => {
                const tr = document.createElement('tr');
                const isSubjective = item.type === "SUBJECTIVE" || item.type === "BOARD";
                
                let btn = currentTab === 'unverified' 
                    ? `<button class="btn-verify" onclick="window.toggleVerify(this, '${item.id}', true)">‚úÖ Approve</button>`
                    : `<button class="btn-unverify" onclick="window.toggleVerify(this, '${item.id}', false)">‚Ü© Un-Approve</button>`;

                let answerContent = isSubjective 
                    ? `<div style="font-size:0.9em;"><span style="color:#d32f2f; font-weight:bold;">${item.category || 'Board/Sub'}</span><br>${item.answerText || '<i>No text</i>'}${item.answerImage ? `<br><a href="${item.answerImage}" target="_blank">View Img</a>` : ''}</div>`
                    : `<div style="font-size:0.85em;">A: ${item.options?.A}<br>B: ${item.options?.B}<br>C: ${item.options?.C}<br>D: ${item.options?.D}<br><strong style="color:green">Ans: ${item.answer}</strong></div>`;

                let editFields = isSubjective ? `
                    <label>Category:</label>
                    <select id="cat-${item.id}">
                        <option value="Very Short" ${item.category === 'Very Short' ? 'selected' : ''}>Very Short</option>
                        <option value="Short" ${item.category === 'Short' ? 'selected' : ''}>Short</option>
                        <option value="Long" ${item.category === 'Long' ? 'selected' : ''}>Long</option>
                    </select>
                    <label>Answer Text: <span class="visual-edit-btn" onclick="openAdminEditor('ansTxt-${item.id}')">‚úè Editor</span></label> 
                    <textarea id="ansTxt-${item.id}" rows="3">${item.answerText || ''}</textarea>
                    <label>New Answer Img:</label> <input type="file" id="ansFile-${item.id}">
                ` : `
                    <label>Options:</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
                        <input type="text" id="opA-${item.id}" value="${item.options?.A || ''}" placeholder="A">
                        <input type="text" id="opB-${item.id}" value="${item.options?.B || ''}" placeholder="B">
                        <input type="text" id="opC-${item.id}" value="${item.options?.C || ''}" placeholder="C">
                        <input type="text" id="opD-${item.id}" value="${item.options?.D || ''}" placeholder="D">
                    </div>
                    <label>Correct Ans:</label>
                    <select id="ansMCQ-${item.id}">
                        <option value="A" ${item.answer === 'A' ? 'selected' : ''}>A</option>
                        <option value="B" ${item.answer === 'B' ? 'selected' : ''}>B</option>
                        <option value="C" ${item.answer === 'C' ? 'selected' : ''}>C</option>
                        <option value="D" ${item.answer === 'D' ? 'selected' : ''}>D</option>
                    </select>
                `;

                tr.innerHTML = `
                    <td>
                        <span style="background:#e3f2fd; color:#0d47a1; padding:2px 6px; border-radius:4px; font-size:0.8em; font-weight:bold;">${item.exam}</span>
                        <div style="font-weight:bold; margin-top:5px;">${item.teacher}</div>
                        <div style="color:gray; font-size:0.85em;">${item.subject}</div>
                        <small style="color:#aaa; font-size:0.75em;">ID: ${item.id.substr(0,6)}...</small>
                    </td>
                    <td>
                        <div id="disp-q-${item.id}" class="content-text">
                            ${item.question}
                            ${item.imageUrl ? `<br><a href="${item.imageUrl}" target="_blank"><img src="${item.imageUrl}" class="thumb"></a>` : ''}
                        </div>
                        <div id="edit-${item.id}" class="edit-box">
                            <label>Question: <span class="visual-edit-btn" onclick="openAdminEditor('txt-${item.id}')">‚úè Open Editor</span></label> 
                            <textarea id="txt-${item.id}" rows="4">${item.question}</textarea>
                            <label>New Question Img:</label> <input type="file" id="file-${item.id}">
                            ${editFields}
                            <div style="margin-top:10px;">
                                <button onclick="window.saveAdminEdit('${item.id}', '${item.type}')" style="background:#2e7d32; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Save Changes</button>
                                <button onclick="window.toggleEdit('${item.id}')" style="background:#777; color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">Cancel</button>
                            </div>
                        </div>
                    </td>
                    <td>${answerContent}</td>
                    <td>
                        <div class="action-col">
                            ${btn}
                            <button class="btn-edit" onclick="window.toggleEdit('${item.id}')">‚úè Edit</button>
                            <button class="btn-delete" onclick="window.deleteQ('${item.id}')">üóë Delete</button>
                        </div>
                    </td>
                `;
                fragment.appendChild(tr);
            });
            tbody.appendChild(fragment);
        }

        // --- ACTIONS ---
        window.toggleVerify = async (btn, id, status) => { 
            btn.innerText = "..."; btn.disabled = true;
            try { await updateDoc(doc(db, "questions", id), { verified: status }); } catch (e) { alert(e.message); } 
        }
        window.deleteQ = async (id) => { if(confirm("Delete permanently?")) await deleteDoc(doc(db, "questions", id)); }
        
        window.toggleEdit = (id) => {
            const box = document.getElementById(`edit-${id}`);
            const dispQ = document.getElementById(`disp-q-${id}`);
            box.style.display = box.style.display === "block" ? "none" : "block";
            dispQ.style.display = dispQ.style.display === "none" ? "block" : "none";
        }

        window.downloadJSON = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allData, null, 2));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", `Data_${currentTab}_${Date.now()}.json`);
            dl.click();
        }

        // --- EDITOR & IMAGE ---
        window.openAdminEditor = (targetId) => {
            activeEditId = targetId;
            document.getElementById('ed-body').innerHTML = document.getElementById(targetId).value;
            document.getElementById('fs-editor').style.display = 'flex';
        };
        window.closeAdminEditor = () => {
            document.getElementById(activeEditId).value = document.getElementById('ed-body').innerHTML;
            document.getElementById('fs-editor').style.display = 'none';
        };
        window.execCmd = (cmd, val = null) => { document.execCommand(cmd, false, val); };

        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = Math.min(img.width, 800);
                        canvas.height = img.height * (canvas.width / img.width);
                        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                    };
                };
            });
        };

        window.saveAdminEdit = async (id, type) => {
            const btn = document.querySelector(`#edit-${id} button`);
            const prevText = btn.innerText; btn.innerText = "Saving..."; btn.disabled = true;
            try {
                let updates = { question: document.getElementById(`txt-${id}`).value };
                const qFile = document.getElementById(`file-${id}`).files[0];
                if (qFile) updates.imageUrl = await compressImage(qFile);

                if (type === "SUBJECTIVE" || type === "BOARD") {
                    updates.category = document.getElementById(`cat-${id}`).value;
                    updates.answerText = document.getElementById(`ansTxt-${id}`).value;
                    const aFile = document.getElementById(`ansFile-${id}`).files[0];
                    if (aFile) updates.answerImage = await compressImage(aFile);
                } else {
                    updates.options = {
                        A: document.getElementById(`opA-${id}`).value,
                        B: document.getElementById(`opB-${id}`).value,
                        C: document.getElementById(`opC-${id}`).value,
                        D: document.getElementById(`opD-${id}`).value,
                    };
                    updates.answer = document.getElementById(`ansMCQ-${id}`).value;
                }
                await updateDoc(doc(db, "questions", id), updates);
                window.toggleEdit(id);
            } catch (e) { alert("Error: " + e.message); }
            finally { btn.innerText = prevText; btn.disabled = false; }
        };
    </script>
</body>
</html>
